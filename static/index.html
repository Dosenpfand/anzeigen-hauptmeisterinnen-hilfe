<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-T-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anzeigen-Hauptmeister*innen-Hilfe</title>
    <style>
        :root {
            --background-color: #f4f4f9;
            --text-color: #333;
            --container-background: #fff;
            --input-border-color: #ddd;
            --input-background-color: #fff;
            --button-background-color: #007bff;
            --button-text-color: white;
            --button-hover-background-color: #0056b3;
            --action-button-background-color: #28a745;
            --action-button-hover-background-color: #218838;
            --response-background-color: #e9ecef;
            --response-border-color: #ced4da;
            --header-color: #007bff;
            --spinner-border-light: #f3f3f3;
            --spinner-border-top: #007bff;
            --toggle-slider-background: #ccc;
            --toggle-slider-checked-background: #007bff;
            --toggle-slider-knob-background: white;
        }

        [data-theme="dark"] {
            --background-color: #121212;
            --text-color: #e0e0e0;
            --container-background: #1e1e1e;
            --input-border-color: #444;
            --input-background-color: #2a2a2a;
            --button-background-color: #007bff;
            --button-text-color: white;
            --button-hover-background-color: #0056b3;
            --action-button-background-color: #28a745;
            --action-button-hover-background-color: #218838;
            --response-background-color: #2c2c2c;
            --response-border-color: #444;
            --header-color: #3aa0ff;
            --spinner-border-light: #444;
            --spinner-border-top: #3aa0ff;
            --toggle-slider-background: #555;
            --toggle-slider-checked-background: #3aa0ff;
            --toggle-slider-knob-background: #e0e0e0;
        }

        .source-code-link {
            text-align: right;
            margin-top: 20px;
            font-size: 0.8em;
        }

        .source-code-link a {
            color: gray;
            text-decoration: none;
        }

        .source-code-link a:hover {
            text-decoration: underline;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 40px;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            background-color: var(--container-background);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
            margin-top: 15px;
            transition: background-color 0.3s;
        }
        [data-theme="dark"] .container {
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        h1 {
            color: var(--header-color);
            text-align: center;
            margin-bottom: 20px;
            transition: color 0.3s;
        }
        h2.subtitle {
            color: var(--text-color);
            text-align: center;
            margin-top: -10px;
            margin-bottom: 25px;
            font-size: 1.2em;
            font-weight: normal;
            transition: color 0.3s;
        }
        .explanation {
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 0.95em;
            line-height: 1.6;
            transition: color 0.3s;
            padding-left: 20px;
        }
        .explanation li {
            text-align: left;
            margin-bottom: 10px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-color);
            transition: color 0.3s;
        }
        input[type="file"] {
            display: block;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid var(--input-border-color);
            background-color: var(--input-background-color);
            color: var(--text-color);
            border-radius: 4px;
            width: calc(100% - 22px);
            transition: border-color 0.3s, background-color 0.3s, color 0.3s;
        }

        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .form-row label {
            display: inline;
            margin-bottom: 0;
            margin-right: 10px;
        }

        .form-row input[type="checkbox"] {
            margin-right: 5px;
            margin-left: 0;
            flex-shrink: 0;
        }

        .form-row label[for="termsCheckbox"] {
            margin-right: 0;
        }

        button {
            background-color: var(--button-background-color);
            color: var(--button-text-color);
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: var(--button-hover-background-color);
        }
        .action-button {
            background-color: var(--action-button-background-color);
            color: var(--button-text-color);
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            margin-top: 15px;
            display: none;
        }
        .action-button:hover {
            background-color: var(--action-button-hover-background-color);
        }
        #response {
            margin-top: 30px;
            padding: 15px;
            background-color: var(--response-background-color);
            border: 1px solid var(--response-border-color);
            color: var(--text-color);
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: "Courier New", Courier, monospace;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        .error {
            color: red;
            margin-top: 10px;
        }
        #loadingSpinner {
            border: 5px solid var(--spinner-border-light);
            border-top: 5px solid var(--spinner-border-top);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            transition: border-color 0.3s;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            position: absolute;
            top: 15px;
            right: 8px;
        }
        .theme-switch-wrapper label {
            margin-right: 8px;
            font-weight: normal;
        }
        .theme-switch {
            display: inline-block;
            height: 24px;
            position: relative;
            width: 50px;
        }
        .theme-switch input {
            display:none;
        }
        .slider {
            background-color: var(--toggle-slider-background);
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            background-color: var(--toggle-slider-knob-background);
            bottom: 4px;
            content: "";
            height: 16px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 16px;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--toggle-slider-checked-background);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: var(--container-background);
            color: var(--text-color);
            margin: auto;
            padding: 20px;
            border: 1px solid var(--input-border-color);
            border-radius: 8px;
            width: 80%;
            max-width: 700px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }
        .modal-content h2 {
            color: var(--header-color);
            margin-top: 0;
        }
        .modal-content a {
            color: var(--header-color);
        }
        .close-button {
            color: var(--text-color);
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .close-button:hover,
        .close-button:focus {
            color: #ff0000;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="theme-switch-wrapper">
        <label for="themeSwitch">‚òÄÔ∏èüåë</label>
        <label class="theme-switch" for="themeSwitch">
            <input type="checkbox" id="themeSwitch">
            <span class="slider round"></span>
        </label>
    </div>
    <div class="container">
        <h1>Anzeigen-Hauptmeister*innen-Hilfe</h1>
        <h2 class="subtitle">Falsch geparkte Fahrzeuge in Wien melden</h2>
        <ol class="explanation">
            <li>üì∏ Lade ein Foto von einem falsch geparkten Auto hoch.</li>
            <li>‚öôÔ∏è Datum, Ort sowie Kennzeichen werden extrahiert.</li>
            <li>üìß Erhalte eine E-Mail-Vorlage an die Parkraum√ºberwachung der MA 67.</li>
        </ol>
        <form id="uploadForm">
            <input type="file" id="fileInput" name="file" accept=".jpg, .jpeg" required>

            <div class="form-row" style="font-size: 0.9em;">
                <input type="checkbox" id="termsCheckbox" name="terms" required>
                <label for="termsCheckbox" style="font-weight: normal;">Ich akzeptiere die <a href="#" id="termsLink" style="color: var(--header-color);">Nutzungsbedingungen</a>.</label>
            </div>

            <button type="submit" id="submitButton">Infos extrahieren</button>
        </form>

        <div id="termsModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h2>Nutzungsbedingungen</h2>
                <p>Wir speichern keine personenbezogenen Daten von dir direkt auf unseren Servern √ºber den unmittelbaren Verarbeitungsvorgang hinaus.</p>
                <p>Das von dir hochgeladene Foto wird zur Analyse (z.B. Kennzeichenerkennung) an Google Gemini (Vertex AI), einen Dienst von Google, weitergeleitet und dort verarbeitet. Durch das Hochladen des Bildes und die Nutzung dieses Dienstes stimmst du dieser Verarbeitung zu.</p>
                <p>Bitte beachte die Datenschutzbestimmungen von Google und Google Cloud:</p>
                <ul>
                    <li><a href="https://policies.google.com/privacy" target="_blank" rel="noopener noreferrer">Google Datenschutzerkl√§rung</a></li>
                    <li><a href="https://cloud.google.com/terms/cloud-privacy-notice" target="_blank" rel="noopener noreferrer">Google Cloud Datenschutzerkl√§rung</a></li>
                </ul>
                <p>Durch Anklicken der Checkbox "Nutzungsbedingungen akzeptieren" best√§tigst du, dass du diese Bedingungen zur Kenntnis genommen hast und akzeptierst.</p>
            </div>
        </div>

        <div id="loadingSpinner" style="display: none;"></div>
        <div id="responseArea">
            <h2 id="responseHeader" style="display: none;">E-Mail-Entwurf</h2>
            <pre id="response" style="display: none;"></pre>
            <button id="openEmailClientButton" class="action-button">In deinem E-Mail-Programm √∂ffnen</button>
            <p id="errorMessage" class="error"></p>
        </div>

        <div class="source-code-link">
            <a href="https://github.com/Dosenpfand/falschparker" target="_blank" rel="noopener noreferrer">Quellcode</a>
            &nbsp;|&nbsp;
            <a href="mailto:falschparker@sad.bz">Kontakt</a>
        </div>
    </div>

    <script>
        const errorTranslations = {
            "No selected file": "Bitte w√§hle eine Datei aus.",
            "File is not a JPG image": "Ung√ºltiges Dateiformat. Bitte lade ein JPG- oder JPEG-Bild hoch.",
            "Cannot identify image file. It might be corrupted or not a valid JPG.": "Das Bild konnte nicht verarbeitet werden. Es ist m√∂glicherweise besch√§digt oder kein g√ºltiges JPG/JPEG-Format.",
            "Could not open image": "Das Bild konnte nicht ge√∂ffnet werden. Es ist m√∂glicherweise besch√§digt.",
            "An unexpected server error occurred.": "Ein unerwarteter Fehler auf dem Server ist aufgetreten. Bitte versuche es sp√§ter erneut.",
            "Rate limit exceeded": "Zu viele Anfragen. Bitte versuche es sp√§ter erneut.",
            "generic_client_error": "Ein unerwarteter Fehler ist aufgetreten. Bitte versuche es sp√§ter erneut oder √ºberpr√ºfe die Browser-Konsole f√ºr technische Details.",
            "terms_not_accepted": "Bitte akzeptiere die Nutzungsbedingungen, um fortzufahren."
        };

        const termsModal = document.getElementById('termsModal');
        const termsLink = document.getElementById('termsLink');
        const closeButton = document.querySelector('.close-button');

        if (termsLink) {
            termsLink.onclick = function(e) {
                e.preventDefault();
                termsModal.style.display = 'flex';
            }
        }

        if (closeButton) {
            closeButton.onclick = function() {
                termsModal.style.display = 'none';
            }
        }

        window.onclick = function(event) {
            if (event.target == termsModal) {
                termsModal.style.display = 'none';
            }
        }

        document.getElementById('uploadForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const fileInput = document.getElementById('fileInput');
            const responseElement = document.getElementById('response');
            const responseHeaderElement = document.getElementById('responseHeader');
            const errorMessageElement = document.getElementById('errorMessage');
            const emailButton = document.getElementById('openEmailClientButton');
            const submitButton = document.getElementById('submitButton');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const termsCheckbox = document.getElementById('termsCheckbox');

            responseElement.textContent = '';
            responseElement.style.display = 'none';
            responseHeaderElement.style.display = 'none';
            errorMessageElement.textContent = '';
            emailButton.style.display = 'none';
            loadingSpinner.style.display = 'none';

            if (!fileInput.files.length) {
                errorMessageElement.textContent = errorTranslations["No selected file"];
                return;
            }

            if (!termsCheckbox.checked) {
                errorMessageElement.textContent = errorTranslations["terms_not_accepted"];
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                loadingSpinner.style.display = 'block';
                submitButton.disabled = true;

                const response = await fetch('/extract_info/', {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();

                if (response.ok) {
                    const address = data.address || "***nicht verf√ºgbar***";
                    const datetime = data.datetime_original_vienna || "***nicht verf√ºgbar***";
                    const numberPlate = data.number_plate || "***nicht verf√ºgbar***";

                    let formattedDatetime;
                    if (datetime === "***nicht verf√ºgbar***") {
                        formattedDatetime = "***nicht verf√ºgbar***";
                    } else {
                        try {
                            const dateObj = new Date(datetime);
                            if (isNaN(dateObj.getTime())) {
                                formattedDatetime = "***nicht verf√ºgbar***";
                            } else {
                                const options = {
                                    year: 'numeric', month: '2-digit', day: '2-digit',
                                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                                    hour12: false
                                };
                                formattedDatetime = dateObj.toLocaleString('de-DE', options) + " Uhr";
                            }
                        } catch (e) {
                            console.warn("Could not reformat datetime:", e);
                            formattedDatetime = "***nicht verf√ºgbar***";
                        }
                    }

                    const reportText = `Sehr geehrtes Team der P√úG Wien,
hiermit m√∂chte ich einen Falschparker melden.

Ort: ${address}
Datum und Uhrzeit: ${formattedDatetime}
Fahrzeugkennzeichen: ${numberPlate}
Fotos: Im Anhang

F√ºr R√ºckfragen stehe ich selbstverst√§ndlich gerne per E-Mail zur Verf√ºgung.

Mit freundlichen Gr√º√üen`;
                    responseHeaderElement.style.display = 'block';
                    responseElement.style.display = 'block';
                    responseElement.textContent = reportText;
                    emailButton.style.display = 'block';

                    emailButton.onclick = function() {
                        const emailRecipient = 'rechtsmittel@ma67.wien.gv.at';

                        let subjectDate = '';
                        try {
                            const dateObj = new Date(datetime);
                            const day = String(dateObj.getDate()).padStart(2, '0');
                            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                            const year = dateObj.getFullYear();
                            subjectDate = `${day}.${month}.${year}`;
                        } catch (e) {
                            console.warn("Could not format date for subject:", e);
                            subjectDate = datetime.split('T')[0];
                        }

                        const emailSubject = `Falschparker ${subjectDate}, ${address}`;
                        const emailBody = encodeURIComponent(reportText);
                        window.location.href = `mailto:${emailRecipient}?subject=${encodeURIComponent(emailSubject)}&body=${emailBody}`;
                    };

                } else {
                    const errorKey = data.detail || data.error;
                    let displayErrorMessage;

                    if (errorKey && typeof errorKey === 'string') {
                        if (errorTranslations[errorKey]) {
                            displayErrorMessage = errorTranslations[errorKey];
                        } else if (errorKey.startsWith("Could not open image:")) {
                            displayErrorMessage = errorTranslations["Could not open image"];
                        } else if (errorKey.startsWith("Rate limit exceeded")) {
                            displayErrorMessage = errorTranslations["Rate limit exceeded"];
                        } else {
                            displayErrorMessage = errorTranslations["An unexpected server error occurred."];
                        }
                    } else {
                        displayErrorMessage = errorTranslations["An unexpected server error occurred."];
                    }
                    errorMessageElement.textContent = displayErrorMessage;
                    responseElement.textContent = '';
                    responseElement.style.display = 'none';
                    responseHeaderElement.style.display = 'none';
                    emailButton.style.display = 'none';
                }
            } catch (error) {
                console.error('Error:', error);
                errorMessageElement.textContent = errorTranslations["generic_client_error"];
                responseElement.textContent = '';
                responseElement.style.display = 'none';
                responseHeaderElement.style.display = 'none';
            } finally {
                loadingSpinner.style.display = 'none';
                submitButton.disabled = false;
            }
        });
    </script>

    <script>
        const themeSwitch = document.getElementById('themeSwitch');
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

        /**
         * Sets the theme on the document and in localStorage.
         * @param {string} theme - The theme to set ('light' or 'dark').
         * @param {string} source - The source of the theme change ('auto', 'manual', 'system').
         */
        function setTheme(theme, source = 'auto') {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            themeSwitch.checked = theme === 'dark';

            if (source === 'manual') {
                localStorage.setItem('themeManuallySet', 'true');
            } else if (source === 'system') {
                localStorage.removeItem('themeManuallySet');
            }
        }

        const manuallySetPreviously = localStorage.getItem('themeManuallySet') === 'true';
        const currentSavedTheme = localStorage.getItem('theme');

        if (manuallySetPreviously && currentSavedTheme) {
            setTheme(currentSavedTheme, 'auto');
        } else if (prefersDarkScheme.matches) {
            setTheme('dark', 'system');
        } else {
            setTheme('light', 'system');
        }

        themeSwitch.addEventListener('change', function(event) {
            setTheme(event.target.checked ? 'dark' : 'light', 'manual');
        });

        prefersDarkScheme.addEventListener('change', (e) => {
            if (localStorage.getItem('themeManuallySet') !== 'true') {
                setTheme(e.matches ? 'dark' : 'light', 'system');
            }
        });
    </script>
</body>
</html>
