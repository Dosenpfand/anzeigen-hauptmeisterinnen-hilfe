<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-T-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falschparker melden</title>
    <style>
        :root {
            --background-color: #f4f4f9;
            --text-color: #333;
            --container-background: #fff;
            --input-border-color: #ddd;
            --input-background-color: #fff;
            --button-background-color: #007bff;
            --button-text-color: white;
            --button-hover-background-color: #0056b3;
            --action-button-background-color: #28a745;
            --action-button-hover-background-color: #218838;
            --response-background-color: #e9ecef;
            --response-border-color: #ced4da;
            --header-color: #007bff;
            --spinner-border-light: #f3f3f3;
            --spinner-border-top: #007bff;
            --toggle-slider-background: #ccc;
            --toggle-slider-checked-background: #007bff;
            --toggle-slider-knob-background: white;
        }

        [data-theme="dark"] {
            --background-color: #121212;
            --text-color: #e0e0e0;
            --container-background: #1e1e1e;
            --input-border-color: #444;
            --input-background-color: #2a2a2a;
            --button-background-color: #007bff;
            --button-text-color: white;
            --button-hover-background-color: #0056b3;
            --action-button-background-color: #28a745;
            --action-button-hover-background-color: #218838;
            --response-background-color: #2c2c2c;
            --response-border-color: #444;
            --header-color: #3aa0ff; /* Lighter blue for dark theme */
            --spinner-border-light: #444;
            --spinner-border-top: #3aa0ff;
            --toggle-slider-background: #555;
            --toggle-slider-checked-background: #3aa0ff;
            --toggle-slider-knob-background: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 40px;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            background-color: var(--container-background);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
            transition: background-color 0.3s;
        }
        [data-theme="dark"] .container {
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        h1 {
            color: var(--header-color);
            text-align: center;
            margin-bottom: 20px;
            transition: color 0.3s;
        }
        label { /* Applies to form labels */
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-color);
            transition: color 0.3s;
        }
        input[type="file"] {
            display: block;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid var(--input-border-color);
            background-color: var(--input-background-color);
            color: var(--text-color);
            border-radius: 4px;
            width: calc(100% - 22px); /* Account for padding and border */
            transition: border-color 0.3s, background-color 0.3s, color 0.3s;
        }
        button {
            background-color: var(--button-background-color);
            color: var(--button-text-color);
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: var(--button-hover-background-color);
        }
        .action-button {
            background-color: var(--action-button-background-color);
            color: var(--button-text-color); /* Assuming same text color as other buttons */
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            margin-top: 15px;
            display: none; /* Hidden by default */
        }
        .action-button:hover {
            background-color: var(--action-button-hover-background-color);
        }
        #response {
            margin-top: 30px;
            padding: 15px;
            background-color: var(--response-background-color);
            border: 1px solid var(--response-border-color);
            color: var(--text-color);
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: "Courier New", Courier, monospace;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        .error {
            color: red; /* Keeping red for errors as it stands out */
            margin-top: 10px;
        }
        #loadingSpinner {
            border: 5px solid var(--spinner-border-light);
            border-top: 5px solid var(--spinner-border-top);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            transition: border-color 0.3s;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Theme toggle switch styles */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            position: absolute;
            top: 15px;
            right: 15px;
        }
        .theme-switch-wrapper label { /* Styles the "Dark Mode" text */
            margin-right: 8px;
            font-weight: normal; /* Override bold from general label style if desired */
        }
        .theme-switch {
            display: inline-block;
            height: 24px;
            position: relative;
            width: 50px;
        }
        .theme-switch input {
            display:none;
        }
        .slider {
            background-color: var(--toggle-slider-background);
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            background-color: var(--toggle-slider-knob-background);
            bottom: 4px;
            content: "";
            height: 16px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 16px;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--toggle-slider-checked-background);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <div class="theme-switch-wrapper">
        <label for="themeSwitch">‚òÄÔ∏èüåô</label> <!-- This label makes the text "Dark Mode" clickable -->
        <label class="theme-switch" for="themeSwitch"> <!-- This new label makes the visual slider part clickable -->
            <input type="checkbox" id="themeSwitch">
            <span class="slider round"></span>
        </label>
    </div>
    <div class="container">
        <h1>Falschparker melden</h1>
        <form id="uploadForm">
            <label for="fileInput">Choose a JPG image</label>
            <input type="file" id="fileInput" name="file" accept=".jpg, .jpeg" required>
            <button type="submit" id="submitButton">Extract info</button>
        </form>
        <div id="loadingSpinner" style="display: none;"></div> <!-- Spinner Element -->
        <div id="responseArea">
            <h2 id="responseHeader" style="display: none;">E-Mail</h2>
            <pre id="response" style="display: none;"></pre>
            <button id="openEmailClientButton" class="action-button">Open in Email Client</button>
            <p id="errorMessage" class="error"></p>
        </div>
    </div>

    <script>
        document.getElementById('uploadForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const fileInput = document.getElementById('fileInput');
            const responseElement = document.getElementById('response');
            const responseHeaderElement = document.getElementById('responseHeader'); // Get the header
            const errorMessageElement = document.getElementById('errorMessage');
            const emailButton = document.getElementById('openEmailClientButton');
            const submitButton = document.getElementById('submitButton');
            const loadingSpinner = document.getElementById('loadingSpinner');

            // Reset UI
            responseElement.textContent = '';
            responseElement.style.display = 'none';
            responseHeaderElement.style.display = 'none';
            errorMessageElement.textContent = '';
            emailButton.style.display = 'none';
            loadingSpinner.style.display = 'none';

            if (!fileInput.files.length) {
                errorMessageElement.textContent = 'Please select a file.';
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                loadingSpinner.style.display = 'block'; // Show spinner
                submitButton.disabled = true; // Disable submit button

                const response = await fetch('/extract_info/', {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();

                if (response.ok) {
                    const address = data.address || "nicht verf√ºgbar";
                    const datetime = data.datetime_original_vienna; // Assuming this is always present on success
                    const numberPlate = data.number_plate || "nicht verf√ºgbar";

                    // Format datetime_original_vienna for better readability
                    let formattedDatetime = datetime;
                    try {
                        // Attempt to format the ISO string to a more common German representation
                        const dateObj = new Date(datetime);
                        const options = {
                            year: 'numeric', month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit', second: '2-digit',
                            hour12: false // Use 24-hour format
                        };
                        // Using German locale for date and time formatting
                        formattedDatetime = dateObj.toLocaleString('de-DE', options) + " Uhr";
                    } catch (e) {
                        console.warn("Could not reformat datetime:", e);
                        // Fallback to original if formatting fails
                        formattedDatetime = datetime;
                    }

                    const reportText = `Sehr geehrtes Team der P√úG Wien,
hiermit m√∂chte ich einen Falschparker melden.

Ort: ${address}
Datum und Uhrzeit: ${formattedDatetime}
Fahrzeugkennzeichen: ${numberPlate}
Fotos: Im Anhang

F√ºr R√ºckfragen stehe ich selbstverst√§ndliche gerne per E-Mail zur Verf√ºgung.

Mit freundlichen Gr√º√üen`;
                    responseHeaderElement.style.display = 'block'; // Show header
                    responseElement.style.display = 'block'; // Show pre tag
                    responseElement.textContent = reportText;
                    emailButton.style.display = 'block'; // Show the email button

                    // Add or update event listener for the email button
                    emailButton.onclick = function() { // Use onclick for simplicity or manage listeners carefully
                        const emailRecipient = 'rechtsmittel@ma67.wien.gv.at';

                        // Format date for subject (e.g., DD.MM.YYYY)
                        let subjectDate = '';
                        try {
                            const dateObj = new Date(datetime);
                            const day = String(dateObj.getDate()).padStart(2, '0');
                            const month = String(dateObj.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
                            const year = dateObj.getFullYear();
                            subjectDate = `${day}.${month}.${year}`;
                        } catch (e) {
                            console.warn("Could not format date for subject:", e);
                            // Fallback to a generic part of the datetime string if formatting fails
                            subjectDate = datetime.split('T')[0];
                        }

                        const emailSubject = `Falschparker ${subjectDate}, ${address}`;
                        const emailBody = encodeURIComponent(reportText);
                        window.location.href = `mailto:${emailRecipient}?subject=${encodeURIComponent(emailSubject)}&body=${emailBody}`;
                    };

                } else {
                    errorMessageElement.textContent = `Error: ${data.detail || response.statusText}`;
                    responseElement.textContent = '';
                    responseElement.style.display = 'none'; // Ensure hidden on error
                    responseHeaderElement.style.display = 'none'; // Ensure hidden on error
                    emailButton.style.display = 'none';
                }
            } catch (error) {
                console.error('Error:', error);
                errorMessageElement.textContent = 'An unexpected error occurred. Check the console.';
                responseElement.textContent = '';
                responseElement.style.display = 'none'; // Ensure hidden on error
                responseHeaderElement.style.display = 'none'; // Ensure hidden on error
            } finally {
                loadingSpinner.style.display = 'none'; // Hide spinner
                submitButton.disabled = false; // Re-enable submit button
            }
        });
    </script>

    <script>
        const themeSwitch = document.getElementById('themeSwitch');
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

        /**
         * Sets the theme on the document and in localStorage.
         * @param {string} theme - The theme to set ('light' or 'dark').
         * @param {string} source - The source of the theme change ('auto', 'manual', 'system').
         */
        function setTheme(theme, source = 'auto') {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme); // Always store the current theme
            themeSwitch.checked = theme === 'dark';

            if (source === 'manual') {
                localStorage.setItem('themeManuallySet', 'true');
            } else if (source === 'system') {
                // If theme is set by system (initial or subsequent change),
                // it means any prior manual setting is now superseded by system preference
                // (because this branch is only hit if 'themeManuallySet' was not 'true' prior).
                localStorage.removeItem('themeManuallySet');
            }
            // If source === 'auto' (e.g. initial load from localStorage based on a previous manual set):
            // - If localStorage.themeManuallySet was 'true', it remains 'true'.
            // - If localStorage.themeManuallySet was not 'true', it remains not 'true'.
            // So, no explicit action needed for 'themeManuallySet' when source is 'auto' here.
        }

        // Initialize theme
        const manuallySetPreviously = localStorage.getItem('themeManuallySet') === 'true';
        const currentSavedTheme = localStorage.getItem('theme');

        if (manuallySetPreviously && currentSavedTheme) {
            setTheme(currentSavedTheme, 'auto'); // Restore theme, maintaining manual preference status
        } else if (prefersDarkScheme.matches) {
            setTheme('dark', 'system');          // Set based on system preference
        } else {
            setTheme('light', 'system');         // Default to light, set by system logic
        }

        // Listener for toggle switch
        themeSwitch.addEventListener('change', function(event) {
            setTheme(event.target.checked ? 'dark' : 'light', 'manual');
        });

        // Listener for changes in system preference
        prefersDarkScheme.addEventListener('change', (e) => {
            // Only apply system preference if a theme hasn't been manually set by the user.
            if (localStorage.getItem('themeManuallySet') !== 'true') {
                setTheme(e.matches ? 'dark' : 'light', 'system');
            }
        });
    </script>
</body>
</html>
